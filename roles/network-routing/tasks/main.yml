---
- name: set basic sysctl settings for routing
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"

- name: create routing tables
  template:
    src: routetable.conf
    dest: "/etc/iproute2/rt_tables.d/{{ item.key }}.conf"
    owner: root
    group: root
    mode: 0644
  loop: "{{ routing_tables | dict2items }}"

- name: set basic sysctl settings for routing
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  loop: "{{ sysctl_settings_routing_basic }}"

- name: set sysctl settings for ip forwarding
  when: server_type == "gateway" or server_type == "service" or server_type == "monitoring"
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  loop: "{{ sysctl_settings_routing_forwarding }}"

- name: create policy-routing.conf
  template:
    src: policy-routing.conf.j2
    dest: "/etc/systemd/network/{{ ansible_default_ipv4.interface }}.network.d/policy-routing.conf"
  notify: restart networkd
