---
- name: Print the gateway for each host when defined
  ansible.builtin.debug:
    msg: System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.interface }}

- name: set basic sysctl settings for routing
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"

- name: create routing tables
  lineinfile:
    path: /etc/iproute2/rt_tables
    regexp: '^{{ item.value }}'
    line: "{{ item.value }}{{ '\t' }}{{ item.key }}"
    state: present
  loop: "{{ routing_tables | dict2items }}"

- name: set basic sysctl settings for routing
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  loop: "{{ sysctl_settings_routing_basic }}"

- name: set sysctl settings for ip forwarding
  when: server_type == "gateway" or server_type == "service" or server_type == "monitoring"
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  loop: "{{ sysctl_settings_routing_forwarding }}"

- name: create policy-routing.conf
  template:
    src: policy-routing.conf.j2
    dest: "/etc/systemd/network/{{ ansible_default_ipv4.interface }}.network.d/policy-routing.conf"
  notify: restart networkd
